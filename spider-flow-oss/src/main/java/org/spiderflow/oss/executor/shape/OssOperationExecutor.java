package org.spiderflow.oss.executor.shape;

import java.util.Map;

import org.apache.commons.lang3.StringUtils;
import org.spiderflow.ExpressionEngine;
import org.spiderflow.context.SpiderContext;
import org.spiderflow.executor.ShapeExecutor;
import org.spiderflow.model.Shape;
import org.spiderflow.model.SpiderNode;
import org.spiderflow.oss.model.Oss;
import org.spiderflow.oss.model.OssFile;
import org.spiderflow.oss.utils.OSSUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

@Component
public class OssOperationExecutor implements ShapeExecutor{
	
	public static final String OSS_ID = "ossId";
	
	public static final String BYTES = "bytes";
	
	public static final String FILE_NAME = "fileName";
	
	public static final String FILE_PATH = "filePath";
	
	public static final String OPERATION_TYPE = "operationType";
	
	public static final String OPERATION_TYPE_PUT = "ossPut";
	
	public static final String OPERATION_TYPE_DELETE = "ossDelete";
	
	public static final String VARIABLE_NAME = "variableName";
	
	@Autowired
	private ExpressionEngine engine;
	
	@Override
	public String supportShape() {
		return "ossOperation";
	}
	
	@Override
	public Shape shape() {
		Shape shape = new Shape();
		shape.setImage("data:image/png;base64,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");
		shape.setLabel("OSS操作");
		shape.setName("ossOperation");
		shape.setTitle("OSS操作");
		return shape;
	}

	@Override
	public void execute(SpiderNode node, SpiderContext context, Map<String, Object> variables) {
		String ossId = node.getStringJsonValue(OSS_ID);
		Oss oss = (Oss) context.get(OssExecutor.OSS_CONTEXT_KEY + ossId);
		if(!StringUtils.isNotBlank(ossId)){
			context.debug("请选择OSS！");
		}else {
			String operationType = node.getStringJsonValue(OPERATION_TYPE);
			if(operationType.equals(OPERATION_TYPE_PUT)) {
				String bytes = node.getStringJsonValue(BYTES);
				String fileName = node.getStringJsonValue(FILE_NAME);
				Object bytesResult = engine.execute(bytes, variables);
				Object fileNameResult = engine.execute(fileName, variables);
				OssFile ossFile = OSSUtil.uploadFileToOss(oss, (byte[]) bytesResult, (String) fileNameResult, context);
				variables.put(node.getStringJsonValue(VARIABLE_NAME),ossFile);
			}else if(operationType.equals(OPERATION_TYPE_DELETE)){
				String filePath = node.getStringJsonValue(FILE_PATH);
				Object filePathResult = engine.execute(filePath, variables);
				if(filePathResult == null) {
					filePathResult = filePath;
				}
				OSSUtil.deleteFile(oss, (String) filePathResult, context);
			}
		}
	}
	
}
